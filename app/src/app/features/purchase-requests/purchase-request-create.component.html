<mat-toolbar color="primary">
  <button mat-icon-button (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span>Bestellung abschließen</span>
  <span class="spacer"></span>
  <button mat-icon-button (click)="logout()">
    <mat-icon>logout</mat-icon>
  </button>
</mat-toolbar>

<div class="container">
  <div class="form-container">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Lieferinformationen</mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Lieferadresse</mat-label>
            <textarea matInput formControlName="address" rows="3" 
                      placeholder="Straße, Hausnummer&#10;PLZ, Ort&#10;Land"
                      required></textarea>
            @if (orderForm.get('address')?.hasError('required') && orderForm.get('address')?.touched) {
              <mat-error>Lieferadresse ist erforderlich</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Bemerkung (optional)</mat-label>
            <textarea matInput formControlName="description" rows="3" 
                      placeholder="Zusätzliche Informationen zur Bestellung..."></textarea>
          </mat-form-field>

          @if (error()) {
            <div class="error-message">
              {{ error() }}
            </div>
          }

          <div class="actions">
            <button mat-button type="button" (click)="goBack()">
              Abbrechen
            </button>
            <button mat-raised-button color="primary" type="submit" 
                    [disabled]="loading() || orderForm.invalid">
              @if (loading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <ng-container>
                  <mat-icon>check</mat-icon>
                  Bestellung aufgeben
                </ng-container>
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="summary-container">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Bestellübersicht</mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <mat-list>
          @for (selection of selectedProducts(); track selection.product.ID) {
            <mat-list-item>
              <div class="order-item">
                <div class="item-info">
                  <strong>{{ selection.product.name }}</strong>
                  <div class="item-details">
                    {{ selection.quantity }}x {{ selection.product.price | currency:'EUR' }}
                  </div>
                </div>
                <div class="item-total">
                  {{ selection.quantity * selection.product.price | currency:'EUR' }}
                </div>
              </div>
            </mat-list-item>
            <mat-divider></mat-divider>
          }
        </mat-list>

        <div class="total-section">
          <h2>Gesamtbetrag</h2>
          <h2 class="total-amount">{{ getTotalAmount() | currency:'EUR' }}</h2>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
